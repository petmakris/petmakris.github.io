#!/usr/bin/env bash

set -Eeuo pipefail

POSTS_DIR="${1:-$HOME/projects/petmakris.github.io/_posts}"
EDITOR_CMD="${EDITOR:-vim}"

# Collect matching files via glob
shopt -s nullglob
matches=( "$POSTS_DIR"/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-notes.md )
shopt -u nullglob

# Basenames, newest first, take 5
mapfile -t FILES < <(printf '%s\n' "${matches[@]##*/}" | sort -r | head -n 5)

if (( ${#FILES[@]} == 0 )); then
  echo "No posts found matching YYYY-MM-DD-notes.md in: $POSTS_DIR" >&2
  exit 1
fi

# Build menu: TAG (1..N) + DESCRIPTION (filename)
menu_items=()
for i in "${!FILES[@]}"; do
  idx=$(( i + 1 ))
  menu_items+=( "$idx" "${FILES[$i]}" )
done

# Show menu and capture chosen index (because of --no-tags)
choice_idx=$(
  dialog --clear --no-tags \
         --menu "Select a post to edit" 15 70 5 \
         "${menu_items[@]}" \
         2>&1 >/dev/tty
) || exit 1

# Map index back to filename
choice="${FILES[$(( choice_idx - 1 ))]}"

exec $EDITOR_CMD "$POSTS_DIR/$choice"

